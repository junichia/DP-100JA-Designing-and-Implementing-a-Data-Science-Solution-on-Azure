---
lab:
    title: '自動機械学習を使用する'
---

# 自動機械学習を使用する

Azure Machine Learning には、クラウド コンピューティングのスケーラビリティを活用する *自動機械学習* 機能が含まれます。これにより、複数の前処理手法とモデル トレーニング アルゴリズムが並行して自動的に試行されて、データに最適なパフォーマンスの教師あり機械学習モデルが得られます。

この演習では、Azure Machine Learning Studio の自動機械学習にビジュアル インタフェイスを使用します

> **注**: Azure Machine Learning SDK を通じて自動機械学習を利用することもできます。

## 開始する前に

まだ行っていない場合は、*[Azure Machine Learning Workspace を作成する](01-create-a-workspace.md)* の演習を完了して、Azure Machine Learning ワークスペースとコンピューティング インスタンスを作成し、この演習に必要なノートブックのクローンを作成してください。

## コンピューティング リソースを構成する

自動機械学習を使用するには、モデル トレーニング実験を実行するための計算が必要です。

1. Azureサブスクリプションに関連付けられた Microsoft の資格情報を使用して [Azure Machine Learning Studio](https://ml.azure.com?azure-portal=true) にサインインし、Azure Machine Learning ワークスペースを選択します。
2. Azure Machine Learning Studio で、**コンピューティング** ページを表示し、まだ実行されていない場合は、**コンピューティング インスタンス** タブでコンピューティング インスタンスを開始します。このコンピューティング インスタンスを使用して、トレーニングされたモデルをテストします。
3. コンピューティング インスタンスが起動している間、**コンピューティング クラスター** タブに切り替え、次の設定を使用して新しいコンピューティング クラスターを追加します。このクラスターで自動機械学習の実験を実行し、トレーニングの実行を複数のコンピューティング ノードに分散する機能を利用します。
    - **リージョン**: *ワークスペースと同じリージョン*
    - **仮想マシンの優先度**: 専用
    - **仮想マシンの種類**: CPU
    - **仮想マシンのサイズ**: Standard_DS11_v2
    - **コンピューター名**: *一意の名前を入力する*
    - **ノードの最小数**: 0
    - **ノードの最大数**: 2
    - **スケールダウン前のアイドル秒数**: 120
    - **SSH アクセスの有効化**: 未選択

## データセットを作成する

データの処理に使用できるコンピューティング リソースがいくつかできたので、処理するデータを格納および取り込む方法が必要になります。

1. Azure Machine Learning Studio で、**データセット** ページを表示します。データセットは、Azure ML で使用する予定の特定のデータ ファイルまたはテーブルを表します。
3. 次の設定を使用して、Web ファイルから新しいデータセットを作成します。
    * **基本情報**:
        * **Web URL**: https://aka.ms/diabetes-data
        * **名前**: 糖尿病データセット
        * **データセットの種類**: 表形式
        * **説明**: 糖尿病データ
    * **設定とプレビュー**:
        * **ファイル形式**: 区切り
        * **区切り記号**: コンマ
        * **エンコード**: UTF-8
        * **列ヘッダー**: 最初のファイルのヘッダーを使用する
        * **行をスキップ**: なし
    * **スキーマ**:
        * **パス**以外のすべての列を含める
        * 自動的に検出された型を確認する
    * **詳細の確認**:
        * 作成後にデータセットをプロファイリングしない
4. データセットを作成したら、データセットを開き、**探索**ページを表示して、データのサンプルを確認します。このデータは、糖尿病の検査を受けた患者の詳細を表しています。臨床的な測定値に基づいて、患者が糖尿病で陽性と判定される可能性を予測するモデルをトレーニングするために使用します。

    > **注**: 必要に応じて、データセットの*プロファイル*を生成して、より詳細な統計情報を表示できます。

## 自動機械学習の実験を実行する

Azure Machine Learning では、実行する操作は *実験* と呼ばれます。次の手順に従って、自動機械学習を使用して糖尿病の診断を予測する分類モデルをトレーニングする実験を実行します。

1. Azure Machine Learning Studio で、**自動 ML** ページ (**作成者** の下) を表示します。
2. 次の設定を使用して、新しい自動 ML 実行を作成します。
    - **データセットの選択**:
        - **データセット**: 糖尿病データセット
    - **構成の実行**:
        - **新しい実験名**: mslearn-automl-diabetes
        - **ターゲット列**: Diabetic (*これは、モデルが予測するためにトレーニングされるラベルです)*
        - **コンピューティング クラスターの選択**: *前に作成したコンピューティング クラスター*
    - **タスクの種類と設定**:
        - **タスクの種類**: 分類
        - **追加の構成設定:**
            - **プライマリ メトリック**: **AUC_Weighted** を選択 *(このメトリックについては後ほど詳しく説明します!)*
            - **最適なモデルの説明**: オン - *このオプションを選択すると、自動機械学習によって最適なモデルの特徴の重要度が計算されます。これにより、予測されたラベルの各特徴の影響を判断できます。*
            - **ブロックされたアルゴリズム**: すべてのアルゴリズムを選択したままにします
            - **終了条件**:
                - **トレーニング ジョブ時間 (時間単位)**: 0.25 - *これにより、最大 15 分後に実験が終了します。*
                - **メトリック スコアしきい値**: 0.90 - *これにより、モデルの加重 AUC メトリックが 90% 以上になると実験は終了します。*
        - **特徴量化設定:**
            - **特徴量化を有効にする**: オン - *これにより、Azure Machine Learning によってトレーニングの前に特徴量が自動的に前処理されます。*

3. 自動 ML 実行の詳細の送信が完了すると、自動的に開始されます。実行の状態は **プロパティ** ウィンドウで観察できます。
4. 実行の状態が *実行中* に変わったら、**モデル** タブを表示し、トレーニング アルゴリズムと前処理手順の各組み合わせが試行され、生成されたモデルのパフォーマンスが評価されることを確認します。このページは定期的に自動的に更新されますが、 **&#8635; 更新** を選択することもできます。トレーニングを開始する前にクラスター ノードを初期化し、データの特徴量化プロセスを完了させる必要があるため、モデルの表示が開始されるまで 10 分ほどかかることがあります。コーヒーでも飲んで待ちましょう。
5. 実験が完了するまで待ちます。

## 最高のモデルを確認する

実験が終了したら、生成された最適なパフォーマンス モデルを確認できます (この例では、終了条件を使用して実験を停止しました。そのため、実験によって得られた "最適な" モデルは、実際に最適なモデルではなく、この演習で許可されている期間とメトリックの制約内で最も適しているにすぎない可能性があります)。

1. 自動機械学習の実行の **詳細** タブで、最適なモデルの概要を確認します。
2. 最適なモデルの **アルゴリズム名** を選択して、そのモデルを生成した子実行を表示します。

    最適なモデルは、指定した評価メトリック (*AUC_Weighted*) に基づいて識別されます。このメトリックを計算するために、トレーニング プロセスでは、一部のデータを使用してモデルをトレーニングし、*クロス検証* と呼ばれる手法を適用して、トレーニング済みのモデルを、トレーニングに使用されていないデータで反復的にテストし、予測値を実際の既知の値と比較しました。これらの比較から、真陽性、偽陽性、真陰性、偽陰性の *混同行列* が表になり、真陽性率と偽陽性率を比較する受信者操作特性 (ROC) 曲線グラフを含む追加の分類メトリクスが計算されます。この曲線下面積 (AUC) は、分類パフォーマンスを評価するために使用される一般的なメトリックです。
3. *AUC_Weighted* 値の横にある **他のすべてのメトリックを表示** を選択して、分類モデルに対して考えられる他の評価メトリックの値を表示します。
4. **メトリック** タブを選択し、モデルについて表示できるパフォーマンス メトリックを確認します。これらには、検証済みモデルの混同行列を示す **confusion_matrix** 視覚化と、ROC グラフを含む **accuracy_table** 視覚化が含まれます。
5. **説明** タブを選択し、**Global Importance** グラフを表示します。これは、データセット内の各特徴がラベル予測にどの程度影響を与えるかを示しています。

## 予測サービスをデプロイする

自動機械学習を使用していくつかのモデルをトレーニングした後は、クライアント アプリケーションで使用するサービスとして最適なモデルをデプロイできます。

> **注**: Azure Machine Learning では、サービスを Azure Container Instances (ACI) として、または Azure Kubernetes Service (AKS) クラスターにデプロイできます。運用環境のシナリオでは、AKS のデプロイをお勧めします。その場合、*推論クラスター* コンピューティング ターゲットを作成する必要があります。この演習では、テストに適したデプロイ ターゲットである ACI サービスを使用します。また、推論クラスターを作成する必要はありません。

1. 最適なモデルを生成した実行の **詳細** タブを選択します。
2. **デプロイ** ボタンを使用して、次の設定を使用してモデルをデプロイします。
    - **名前**: auto-predict-diabetes
    - **説明**: 糖尿病の予測
    - **コンピューティングの種類**: ACI
    - **認証を有効にする**: オン
3. デプロイが開始するのを待ちます。これには数秒かかることがあります。次に、**モデル** タブの **モデルの概要** セクションで、**auto-predict-diabetes** サービスの **デプロイの状態** が **実行中** になっていることを確認します。この状態が **成功** に変わるまで待ちます。**&#8635; 更新** を定期的に選択する必要があります。
4. Azure Machine Learning Studio の **エンドポイント** ページを表示し、**auto-predict-diabetes** リアルタイム エンドポイントを選択します。次に、**使用** タブを選択し、次の情報を確認します。この情報は、クライアント アプリケーションからデプロイ済みのサービスに接続するために必要です。
    - サービスの REST エンドポイント
    - サービスの主キー
5. 横にある &#10697; リンクを使用して、これらの値をクリップボードにコピーできることに注意してください。

## デプロイされたサービスをテストする

サービスをデプロイしたので、いくつかの単純なコードを使用してテストできます。

1. ブラウザーに **auto-predict-diabetes** サービス ページの **消費** ページが開いた状態で、新しいブラウザー タブを開き、Azure Machine Learning Studio の 2 番目のインスタンスを開きます。次に、新規タブで **ノートブック** ページを表示します。
2. **ノートブック** ページの **マイ ファイル** で、ノートブック リポジトリを複製した **Users/<your-user-name>/mslearn-dp100** フォルダーを参照し、**03 - Get Desiger Prediction.ipynb** ノートブックを開きます。
3. ノートブックが開いたら、前に作成したコンピューティング インスタンスが **コンピューティング** ボックスで選択されていること、およびその状態が **実行中** であることを確認します。
4. ノートブックで、**ENDPOINT** および **PRIMARY_KEY** のプレースホルダーをサービスの値に置き換えます。これは、エンドポイントのページの **消費** タブからコピーできます。
5. コード セルを実行し、Web サービスから返された出力を表示します。

## クリーンアップ

作成した Web サービスは *Azure Container Instance* にホストされます。それ以上実験する予定がない場合は、不要な Azure の使用が発生するのを避けるために、エンドポイントを削除する必要があります。また、再び必要になるまでコンピューティング インスタンスを停止する必要もあります。

1. Azure Machine Learning Studio の **エンドポイント** タブで、**auto-predict-diabetes** エンドポイントを選択します。次に、**削除** (&#128465;)を選択し、エンドポイントを削除することを確認します。
2. **コンピューティング** ページの **コンピューティング インスタンス** タブで、コンピューティング インスタンスを選択し、**停止** を選択します。
